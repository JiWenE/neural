# 熔断器(CircuitBreaker)

[TOC]

## 1 背景
在分布式架构中，熔断的场景主要分为两种：injvm模式和cluster模式。
![CircuitBreaker](https://martinfowler.com/bliki/images/circuitBreaker/state.png)

## 2 实现原理
### 2.1 熔断器状态
- **关闭（Closed）**：关闭状态表示熔断器没有生效，即服务按正常流程处理
- **打开（Open）**：打开状态表示熔断器启用的状态，即所有请求进来都会被拒绝而不被业务处理
- **半开（Half-Open）**：半开状态是介于关闭和打开之间的一种中间状态，表示会尝试放行新的请求至服务进行
处理，如果指定周期内没有达到关闭的条件，则继续下一个时段的熔断，否则关闭熔断进行恢复正常处理

### 2.2 核心流程


## 3 熔断器模式
### 3.1 事件统计熔断器（EventCountCircuitBreaker）
基于事件统计的熔断器，主要是用于解决服务故障率较高时进行隔离熔断的场景。根据事件（主要是基于异常进行判断，
非异常类事件也可以包装成固定异常类型后进行处理）发生的次数进行统计，然后根据配置的阈值来触发式熔断服务。

### 3.2 流量统计熔断器（ThresholdCircuitBreaker）
基于流量统计的熔断器，主要用于解决突发大流量的冲击而防止服务被冲垮的场景。根据流量（可以是正常流量、异常
流量或特定条件的流量）请求次数进行统计，然后根据配置的阈值来触发式熔断服务。

## 4 应用场景
### 4.1 防止流量激增宕机
其核心原理就是针对突增的异常流量超过指定的最高阈值后，直接将服务进行隔离，防止消耗太多资源而宕机。
针对正常运行的服务，突然某一天流量大量的增加，导致服务应用处理不过来而宕机了。为了防止这种情况发生，我们
可以选择基于流量统计的熔断器来保护服务，当发现流量异常大量增加至指定阈值后，触发对应的熔断隔离，直接将请求
隔离一段时间后开始尝试新的流量是否正常，正常则恢复，否则再次进入熔断模式。

### 4.2 筛选不稳定服务
其核心原理就是针对连续不稳定的服务超过指定的最高阈值后，直接将服务进行隔离，防止太多故障而使得用户体验太差。
针对不稳定的服务，因其稳定性是一个波动的过程，我们希望提供相对较稳定的服务，即不希望有太过故障情况发生。
因此我们可以选择基于事件统计的熔断器，当发生异常故障时开始计数，当异常故障次数超过一定阈值后，则触发
熔断隔离，则此时表示服务稳定性较差，需要隔离，防止用户请求到稳定性较差的服务上，从而产生异常故障。